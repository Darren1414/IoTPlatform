
# 前言
        一个通用的物联网架构方案。本框架包含设备登录，设备连接，数据处理，指令控制等基本模块。本框架旨在解决物联网系统通用的问题，如有特殊的系统需要，也可以基于本框架二次开发解决。
        
# 系统总体设计

## 总体架构框图

![架构图](https://github.com/Darren1414/IoTPlatform/blob/master/architecture.png)

## 设备登录过程
        设备登录可以采用登录网关http方式登录。http为大多数开发者熟悉，开发简单。设备通过http报文（一般为json）把设备号，设备类型，位置等信息传递到服务端，服务端验证真伪后通过算法返回一个登录令牌和一个负载较低的连接服务器地址，设备通过这两个信息，使用TCP接入连接服务器，完成登录。

## 设备在线状态维护
        已经登录的设备，通过TCP心跳包，定时向连接服务器上报心跳信息。连接服务器把当前活动的设备登记到缓存数据库（redis），并设置过期时间，如果连接服务器一定时间未收到心跳，则关闭连接同时redis的活动信息亦会自动删除。其中redis中的活动设备信息，是为了管理后台和业务服务器查看当前活动设备使用，作为一个信息交换媒介。
        
## 消息和数据处理
        连接服务器收到的设备信息，通过消息队列（kafka）转发到业务处理服务器。这里通过消息队列的方式，实现了连接服务器和业务处理服务器之间的解耦。因为解耦，连接服务和业务处理可以完成独立开发而不相互影响。比如连接服务因为性能可以使用Java或者C++开发，业务处理因为灵活性的要求可以使用python开发。

## 指令处理
        上述的消息和数据出来，通过kafka消息队列转发，是考虑到kafka的高性能，kafka的多主架构，可以抗住更大量的流量转发。
        但在指令转发场景，更重要的是可靠性，并且通常指令流量不会很大。rabbitmq具有较高的严谨性，数据丢失的可能性更小，故指令通道采用rabbitmq实现转发。
        同时消息和指令通过不同通道转发，可以故障隔离，不会因为消息数据太大，影响了指令的传输。

## 存储设计
        采用不同的数据库，存放不同的数据库方式。业务数据一般要求严谨性，采用关系型数据库mysql，时序数据因为性能的需要，采用时序数据库cratedb。

## 管理后台
        管理后台可以使用典型的B/S系统。管理后台的主要职责是管理当前系统的设备，查看当前接入设备的状态，给设备发送指令等。管理系统可以同时在缓存数据库redis，业务数据库mysql，时序数据库cratedb获取信息进行展示和管理。
